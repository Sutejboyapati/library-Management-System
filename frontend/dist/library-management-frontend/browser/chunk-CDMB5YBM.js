import{a as h,b as p,ga as l,j as m,la as y,m as g,p as n,qa as k,ua as c,x as a}from"./chunk-OW66QSYT.js";var j=(()=>{class o{constructor(e,t){this.http=e,this.router=t,this.tokenKey="authToken",this.userKey="user",this.currentUser=a(null),this.token=a(null),this.user=this.currentUser.asReadonly(),this.isLoggedIn=l(()=>!!this.currentUser()),this.isAdmin=l(()=>this.currentUser()?.role==="admin"),this.initFromStorage()}initFromStorage(){let e=localStorage.getItem(this.tokenKey),t=localStorage.getItem(this.userKey);if(e&&t)try{this.token.set(e),this.currentUser.set(JSON.parse(t))}catch{this.clearAuth()}}login(e){return this.http.post(`${c.apiUrl}/login`,e).pipe(m(t=>{if(t.token){localStorage.setItem(this.tokenKey,t.token);let r=this.parseJwt(t.token),s=r?.userId??r?.UserID??r?.userID,i=r?.Role??r?.role??t.role??"user",u={id:typeof s=="number"||typeof s=="string"?s:0,username:t.username??e.username,role:i};localStorage.setItem(this.userKey,JSON.stringify(u)),this.token.set(t.token),this.currentUser.set(u)}}))}register(e){let t=p(h({},e),{role:e.role??"user"});return this.http.post(`${c.apiUrl}/register`,t)}logout(){this.clearAuth(),this.router.navigate(["/login"])}getToken(){return this.token()??localStorage.getItem(this.tokenKey)}getUserId(){return this.currentUser()?.id??null}clearAuth(){localStorage.removeItem(this.tokenKey),localStorage.removeItem(this.userKey),this.token.set(null),this.currentUser.set(null)}parseJwt(e){try{let r=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),s=decodeURIComponent(atob(r).split("").map(i=>"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(s)}catch{return null}}static{this.\u0275fac=function(t){return new(t||o)(n(y),n(k))}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{j as a};
